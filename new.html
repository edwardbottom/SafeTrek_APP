<!DOCTYPE html>
<html lang="en">
<head>
	<title>App</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0,user-scalable=no">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/css/bootstrap.min.css" integrity="sha384-9gVQ4dYFwwWSjIDZnLEWnxCjeSWFphJiwGPXr1jddIhOegiu1FwO5qRGvFXOdJZ4" crossorigin="anonymous">
   	<script src="/socket.io/socket.io.js"></script>
     <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
      <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
      <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/smoothness/jquery-ui.css">
      <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.2/rollups/aes.js"></script>
      <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7/leaflet.css" />
    <style>
        body {
            text-align: center;
        }
        #map{
           text-align: center;
           margin: 0 auto;  
        }
    </style>
</head>


<body>
<script src="https://cdn.firebase.com/js/client/2.4.2/firebase.js"></script>

<div id="login_screen">
	<div class="card" style="width: 22rem;">
		<br>
		<h3></h3>
		<br>
		Username:
		<input type="text" id="login_username" placeholder = "username" ><br><br>
		Password: 
  		<input type="password" id="login_password" placeholder="password" ><br><br>
  		<button id="login_button" type="button">Login </button><br>
  	<br>
	<button id="go_to_register" type="button">Register </button>
	<br>
	<br>
	<br>
</div>
</div>

<div id="register_screen">
	<div class="card" style="width: 22rem;">
		<br>
		<h3></h3>
		<br>
		Username: 
		<input type="text" id="login_username_register" placeholder = "username"><br><br>
		Password: 
  		<input type="password" id="login_password_register" placeholder="password" ><br><br>
  		ReEnter Password: 
  		<input type="password" id="login_repassword_register" placeholder="reenter password" ><br><br>
  		Home Address:
  		<input type="text" id="address" placeholder="address" required><br><br>
  		Phone Number:
  		<input type="tel" name="telephone" placeholder="888 888 8888" pattern="[0-9]{3} [0-9]{3} [0-9]{4}" maxlength="12" id="phone_number"/> <br><br>
  		Account type: 
  		<input type="radio" name="account_type" value="parent" id="account_type_parent">Parent
  		<input type="radio" name="account_type" value="child" id="account_type_child">Child<br>  
  		<button id="register_button" type="submit"> Register </button> <br>
  		<br>
  	<button id="cancel_register" type="button">Cancel </button>
  </div>
</div>

<div id="home_screen">
	<div class="card" style="width: 22rem;">
		<br>
		<h3></h3>
	<div id="parent_features">
		<p id="child_name">Child Name: None </p>
    	<div id="map" style="width: 275px; height: 275px"></div>
    	<script src="http://cdn.leafletjs.com/leaflet-0.7/leaflet.js"></script>
		<button id="change_child" type="button">Change Child </button><br>
		<button id="add_child" type="button">Add Child </button><br>
	</div>
	<button id="panic_button" type="button">Panic </button><br>
	<button id="medical_button" type="button">Medical </button><br>
	<button id="logout_button" type="button">Logout </button>
</div>
</div>

<div id="change_child_screen">
	<div class="card" style="width: 22rem;">
		<br>
		<h3></h3>
		<br>
		<h4> Select a Child</h4>
		<ul id='children_list'> 
		</ul>
		<button id="cancel_change_child_button" type="button"> Cancel </button>
	</div>
</div>

<div id="add_child_screen">
	<div class="card" style="width: 22rem;">
		<br>
		<h3></h3>
		<br>
		Child Username:
		<input type="text" id="new_child_username" placeholder = "child username"><br>
		<button id="submit_child" type="button"> Submit Child </button><br>
		<button id="cancel_submit_child_button" type="button"> Cancel </button>
	</div>
</div>

<div id="police_screen">
	<div class="card" style="width: 22rem;">
		<br>
		<h3></h3>
		<br>
	<h3> Are you sure you want to send police to your child's location </h3><br>
	<button id="call_police" type="button"> Yes! </button><br>
	<button id="cancel_police_call" type="button"> No! </button>
</div>
</div>

<div id="medical_screen">
	<div class="card" style="width: 22rem;">
		<br>
		<h3></h3>
		<br>
	<h3> Are you sure you want to send medical services to your child's location? </h3>
	<button id="call_medical" type="button"> Yes! </button><br>
	<button id="cancel_medical_call" type="button"> No! </button>
</div>
</div>

<div id="services_contacted_screen">
	<div class="card" style="width: 22rem;">
		<br>
		<h3></h3>
		<br>
	<p> Emergency services have been contacted!</p>
	<button id="return_to_home"> Return to Home </button>
	<div class="container-fluid">
</div>

</body>
<!--<script src="app.js"></script> -->
<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.0/umd/popper.min.js" integrity="sha384-cs/chFZiN24E4KMATLdqdvsezGxaGsi4hLGOzlXwp5UZB1LY//20VyM2taTB4QvJ" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/js/bootstrap.min.js" integrity="sha384-uefMccjFJAIv6A+rW+L4AHf99KvxDjWSu1z9VI8SKNVmz4sk7buKt/6v9KI65qnm" crossorigin="anonymous"></script>



<style>

body {
   text-align: center;
}
/*https://stackoverflow.com/questions/39031224/how-to-center-cards-in-bootstrap-4*/
.card {
        margin: 0 auto; /* Added */
        float: none; /* Added */
        margin-bottom: 10px; /* Added */
}

</style>
<script >
let socketio = io.connect();

//variables for different screens
let login_screen = document.getElementById('login_screen');
let register_screen = document.getElementById('register_screen');
let police_screen = document.getElementById('police_screen');
let medical_screen = document.getElementById('medical_screen');
let services_contacted_screen = document.getElementById('services_contacted_screen');
let change_child_screen = document.getElementById('change_child_screen');
let add_child_screen = document.getElementById('add_child_screen');
let home_screen = document.getElementById("home_screen");
let parent_features = document.getElementById("parent_features");

//variables for buttons
let login_button = document.getElementById('login_button');
let go_to_register_button = document.getElementById('go_to_register');
let register_user_button = document.getElementById('register_button');
let panic_button = document.getElementById('panic_button');
let medical_button = document.getElementById('medical_button');
let call_police_button = document.getElementById('call_police');
let cancel_police_call_button = document.getElementById('cancel_police_call');
let call_medical_button = document.getElementById('call_medical');
let cancel_medical_call_button = document.getElementById('cancel_medical_call');
let cancel_register_button = document.getElementById('cancel_register');
let logout_button = document.getElementById('logout_button');
let return_to_home_button = document.getElementById("return_to_home");
let change_child_button = document.getElementById("change_child");
let add_child_button = document.getElementById("add_child");
let submit_new_child_button = document.getElementById("submit_child");
let cancel_submit_child_button = document.getElementById("cancel_submit_child_button");
let cancel_change_child_button = document.getElementById("cancel_change_child_button");

//universal variables
let logged_in_user;
let account_type;
let selcted_child;
let locTimer;
let getLocTimer;

//sets the intial screen settings
function intialSetup(){
	login_screen.hidden = false;
	register_screen.hidden = true;
	home_screen.hidden = true;
	police_screen.hidden = true;
	medical_screen.hidden = true;
	services_contacted_screen.hidden = true;
	change_child_screen.hidden = true;
	add_child_screen.hidden = true;
}

//loads the page
window.onload = intialSetup();


function loadHomeScreen(){
	if(account_type == "parent"){
		home_screen.hidden = false;
		parent_features.hidden = false;
        var map = L.map('map').setView([38.5852730, -90.4103930], 14);
        mapLink = 
            '<a href="http://openstreetmap.org">OpenStreetMap</a>';
        L.tileLayer(
            'http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; ' + mapLink + ' Contributors',
            maxZoom: 18,
            }).addTo(map);
        //https://leafletjs.com/examples/quick-start/
        var popup = L.popup()
            .setLatLng([38.5852730, -90.4103930])
            .setContent("I am a standalone popup.")
            .openOn(map);
	}
	else{
		home_screen.hidden = false;
		parent_features.hidden = true;
	}
}

function sendLoginRequest(){
	const username = document.getElementById("login_username").value;
	const password_guess = document.getElementById("login_password").value;

	document.getElementById("login_username").value = "";
	document.getElementById("login_password").value = "";
	// Make a URL-encoded string for passing POST data:
          let re = /^[\w_\-]+$/;
          if(re.test(username))
		  {
		  	 socketio.emit('login_attempt',{username:username, password_guess:password_guess});
		  	 socketio.on("user_does_not_exist", function(data){
		  	 	alert("username " + data['username'] + " is not a registered account ");
		  	 	return;
		  	 });
		  	 socketio.on("successful_login", function(data){
		  	 	login_screen.hidden = true;
		  	 	account_type = data['account_type'];
		  	 	if(account_type == 'child'){
		  	 		locTimer = setInterval(tryGeolocation, 10000);
		  	 		console.log("beacon interval set");
		  	 	}
		  	 	console.log("the account type was set to " + account_type);
		  	 	logged_in_user = username;
		  	 	console.log("the logged in user was set to " + logged_in_user);
		  	 	loadHomeScreen();
		  	 });
		  	 socketio.on("bad_login", function(data){
		  	 	alert("not a valid login");
		  	 	return;
		  	 })
		  	 socketio.on("no_user_found", function(data){
		  	 	alert(data['username'] + " is not a valid username");
		  	 	return;
		  	 })
		  }
		  else
		  {
		  	alert("Login failed. Invalid username");
		  }
}

function sendRegisterRequest(){
	const username = document.getElementById("login_username_register").value;
	let password = document.getElementById("login_password_register").value;
	let repassword = document.getElementById("login_repassword_register").value;
	const address = document.getElementById("address").value;
	const phone_number = document.getElementById("phone_number").value;
	let account_type_r;
	let radios = document.getElementsByName("account_type");

	document.getElementById("login_username_register").value = "";
	document.getElementById("login_password_register").value = "";
	document.getElementById("login_repassword_register").value = "";
	document.getElementById("address").value = "";
	document.getElementById("phone_number").value = "";

	//sets account_type to the extracted radio value
	for (let i = 0, length = radios.length; i < length; i++)
	{
 		if (radios[i].checked)
 		{
  		account_type_r = radios[i].value;
  		break;
 		}
	}
	console.log("phone number: " + phone_number)
	if(password != repassword){
		alert("password do not match ");
		return;
	}

        let re = /^[\w_\-]+$/;
        if(re.test(username))
        {
        	socketio.emit('password_hash',{username:username, password:password, address:address, phone_number:phone_number, account_type:account_type_r});

    		socketio.on("username_taken", function(data){
    			alert("username " + data["username"] + " is taken ");
    			return;
    		});
    		socketio.on("user_created", function(data)
    		{
    			alert("user " + data['username'] + " was created");
    			return;
    		});
        }
        else
        {
        	alert("Invalid username; can only contain upper/lowercase letters, numbers, dashes, and underscores");
        	return;
        }
}


login_button.addEventListener("click", function(){
	sendLoginRequest();
});

go_to_register_button.addEventListener("click", function(){
	login_screen.hidden = true;
	register_screen.hidden = false;
});

cancel_register_button.addEventListener("click", function(){
	login_screen.hidden = false;
	register_screen.hidden = true;
});

register_button.addEventListener("click", function(){
	sendRegisterRequest();
	register_screen.hidden = true;
	login_screen.hidden = false;
});

logout_button.addEventListener("click", function(){
	home_screen.hidden = true;
	login_screen.hidden = false;
	if(account_type == 'child'){
		clearInterval(locTimer);
		console.log("interval timer cleared");
	}
	else{
		clearInterval(getLocTimer);
		console.log("get location timer cleared");
	}
	logged_in_user = undefined;
	account_type = undefined;
});


panic_button.addEventListener("click", function(){
	home_screen.hidden = true;
	police_screen.hidden = false; 
});

call_police_button.addEventListener("click", function(){
	police_screen.hidden = true;
	services_contacted_screen.hidden = false;
});

cancel_police_call_button.addEventListener("click", function(){
	police_screen.hidden = true;
	loadHomeScreen();
})

medical_button.addEventListener("click", function(){
	medical_screen.hidden = false;
	home_screen.hidden = true;
});

cancel_medical_call.addEventListener("click", function(){
	medical_screen.hidden = true;
	loadHomeScreen();
});

call_medical_button.addEventListener("click", function(){
	medical_screen.hidden = true;
	services_contacted_screen.hidden = false;
});

return_to_home_button.addEventListener("click", function(){
	services_contacted_screen.hidden = true;
	loadHomeScreen();
});


change_child_button.addEventListener("click", function(){
	home_screen.hidden = true;
	change_child_screen.hidden = false;
	socketio.emit('get_all_children', {parent:logged_in_user});
	socketio.on('all_children', function(data){
		let childrenArray = data['child_array'];
		let html_list = document.getElementById('children_list');
		html_list.innerHTML = "";
		for(let i = 0; i < childrenArray.length; i++){
			let list_iteam = document.createElement("li");
			list_iteam.innerText = childrenArray[i].child;
			list_iteam.addEventListener('click', function(){
				clearInterval(getLocTimer);
				console.log("get location timer cleared");
				selcted_child = list_iteam.innerText;
				document.getElementById("child_name").innerText = "Child Name: " + selcted_child;
				alert("the child " + selcted_child + " has been selected");
				getLocTimer = setInterval( function() {getChildsLocation(logged_in_user,selcted_child);}, 10000);
		  	 	console.log("get location interval has been set");
			});
			list_iteam.setAttribute("id", "Div" + i);
			html_list.appendChild(list_iteam);
		}
	});
});

add_child_button.addEventListener("click", function(){
	home_screen.hidden = true;
	add_child_screen.hidden = false;
});

submit_new_child_button.addEventListener("click", function(){
	loadHomeScreen();
	add_child_screen.hidden = true;
	let child = document.getElementById("new_child_username").value;
	socketio.emit('add_child', {parent:logged_in_user, child:child});
	//if the child is added successfully
	socketio.on('child_added',function(data){
		alert(data['child'] + " has been added");
});
	//if the child does not exist
	socketio.on('child_not_added', function(data){
		alert(data['child'] + " does not exist");
	})
});


cancel_submit_child_button.addEventListener("click", function(){
	home_screen.hidden = false;
	add_child_screen.hidden = true;
});

cancel_change_child_button.addEventListener("click", function(){
	console.log("exit listener reached");
	let list = document.getElementById("children_list");
	change_child_screen.hidden = true;
	loadHomeScreen();
});

//https://stackoverflow.com/questions/39366758/geolocation-without-ssl-connection
//if geolocation is successfull
var browserGeolocationSuccess = function(position) {
    console.log("Browser geolocation success!\n\nlat = " + position.coords.latitude + "\nlng = " + position.coords.longitude);
    let latitude = position.coords.latitude;
    let longitude = position.coords.longitude;
    socketio.emit('update_child_location', {latitude:latitude, longitude:longitude, child:logged_in_user});
};

//if geolcation fails
var browserGeolocationFail = function(error) {
    switch (error.code) {
        case error.TIMEOUT:
            alert("Browser geolocation error !\n\nTimeout.");
            break;
        case error.PERMISSION_DENIED:
            if(error.message.indexOf("Only secure origins are allowed") == 0) {
                tryAPIGeolocation();
            }
            break;
        case error.POSITION_UNAVAILABLE:
            // dirty hack for safari
            if(error.message.indexOf("Origin does not have permission to use Geolocation service") == 0) {
                tryAPIGeolocation();
            } else {
                alert("Browser geolocation error !\n\nPosition unavailable.");
            }
            break;
    }
};

//try geolocation 
var tryGeolocation = function() {
	console.log("try line reached");
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            browserGeolocationSuccess,
            browserGeolocationFail,
            {maximumAge: 50000, timeout: 20000, enableHighAccuracy: true});
    }
};

function accountType(){
	console.log("the account type is "+ account_type);
}

function getChildsLocation(parent, child){
	socketio.emit('getChildsLocation', {parent:parent, child:child});
	socketio.on('location_not_available', function(data){
		console.log("the child's location is not available ");
	});
	socketio.on('child_location', function(data){
		let location_data = location_data['data'];
		let streetAddress = location_data.streetAddress;
		let neighborhood = location_data.neighborhood;
		let pointOfIntrest = location_data.pointOfIntrest;
		console.log(streetAddress + " is the child's street address");
	});
}

</script>
</html>


